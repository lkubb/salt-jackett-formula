{#- -*- coding: utf-8 -*- #}
{#- vim: ft=jinja #}

{#-
    Convenience: Make relative paths absolute.
-#}

{%- set base_path = mapdata.lookup.paths.base %}
{%- for path, val in mapdata.lookup.paths.items() %}
  {%- if val is string and not val.startswith("/") %}
    {%- do mapdata.lookup.paths.update({path: base_path | path_join(val)}) %}
  {%- endif %}
{%- endfor %}

{%- if not mapdata.lookup.user.home %}
  {%- do mapdata.lookup.user.update({"home": base_path}) %}
{%- endif %}


{#-
    Make sure only non-null values are managed.
-#}

{%- set filtered_config = {} %}
{%- for var, val in mapdata.config.general.items() %}
  {%- if val is not none %}
    {%- do filtered_config.update({var: val}) %}
  {%- endif %}
{%- endfor %}

{%- do mapdata.config.update({"general": filtered_config}) %}


{#-
    Automatically generate secrets if they were not specified.
-#}

{%- for key, secret, length in [
            ("config:general", "APIKey", 32),
] %}
  {%- if not mapdata | traverse(key ~ ":" ~ secret) %}
    {#- This has been deprecated and will be removed in v3005 @FIXME -#}
    {%- do mapdata | update_dict_key_value(key,
          {
            secret: salt["grains.get_or_set_hash"](
                      'jackett.' ~ key | replace(":", ".") ~ "." ~ secret,
                      length=length,
                      chars="abcdefghijklmnopqrstuvwxyz0123456789"
                    )
          }
        )
    %}
  {%- endif %}
{%- endfor %}
